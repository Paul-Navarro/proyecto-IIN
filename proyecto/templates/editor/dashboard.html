<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Panel de Editor</title>
        
        {% load static %}
        <link rel="stylesheet" href="{% static 'css/editor_dashboard.css' %}">
        <!-- Bootstrap CSS -->
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    </head>
<body>
    <header>
        <h1>Bienvenido, Editor</h1>
        <nav>
            <ul>
                <li class="btn btn-home"><a href="{% url 'home' %}">Inicio</a></li>
                <li><a href="#">Gestionar Contenidos</a></li>
                <li><a href="{% url 'account_logout' %}">Cerrar Sesión</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <section>
            <h2>Tablero Kanban</h2>
            <div class="kanban-board">
                <!-- Columna Borrador -->
                <div class="kanban-column" id="borrador" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h3>Borrador</h3>
                    <div class="kanban-items">
                        {% for contenido in contenidos %}
                            {% if contenido.estado_conte == 'BORRADOR' %}
                                <div class="kanban-item" id="item{{ contenido.pk }}" draggable="true" ondragstart="drag(event)">
                                    <h4>{{ contenido.titulo_conte }}</h4>
                                    <a href="{% url 'contenido_update_editor' contenido.id_conte %}" class="btn btn-ver">Editar</a>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Columna En revisión -->
                <div class="kanban-column" id="en_revision" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h3>En Revisión</h3>
                    <div class="kanban-items">
                        {% for contenido in contenidos %}
                            {% if contenido.estado_conte == 'EN_REVISION' %}
                                <div class="kanban-item" id="item{{ contenido.pk }}" draggable="true" ondragstart="drag(event)">
                                    <h4>{{ contenido.titulo_conte }}</h4>
                                    <a href="{% url 'contenido_detail' contenido.pk %}" class="btn btn-ver">Ver</a>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Columna A publicar -->
                <div class="kanban-column" id="a_publicar" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h3>A Publicar</h3>
                    <div class="kanban-items">
                        {% for contenido in contenidos %}
                            {% if contenido.estado_conte == 'A_PUBLICAR' %}
                                <div class="kanban-item" id="item{{ contenido.pk }}" draggable="false" ondragstart="drag(event)">
                                    <h4>{{ contenido.titulo_conte }}</h4>
                                    <a href="{% url 'contenido_detail' contenido.pk %}" class="btn btn-ver">Editar</a>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Permitir que los elementos sean arrastrables
        function allowDrop(ev) {
            ev.preventDefault();
        }
    
        // Empezar a arrastrar
        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }
    
        // Soltar el elemento en la nueva columna y cambiar su estado
        function drop(ev) {
            ev.preventDefault();
            var data = ev.dataTransfer.getData("text");
            var draggedItem = document.getElementById(data);
            
            // Asegurarse de que se suelte en el área correcta (columna)
            if (ev.target.classList.contains('kanban-items')) {
                var targetColumn = ev.target.closest('.kanban-column').id;

                // Verificar si el usuario tiene permiso para mover a "A Publicar"
                if (targetColumn === 'a_publicar') {
                    var userRole = '{{ user.role }}';  // Suponiendo que el rol del usuario esté disponible en la plantilla
                    
                    if (userRole !== 'Publicador') {
                        $('#warningModal').modal('show');  // Mostrar el modal de advertencia
                        return;  // Evitar que se complete la acción de arrastre
                    }
                    
                }

                ev.target.appendChild(draggedItem);
                
                // Llamada AJAX para actualizar el estado en el servidor
                fetch(`/contenido/contenido/cambiar_estado/${data.replace('item', '')}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'  // Asegúrate de que el token CSRF esté presente
                    },
                    body: JSON.stringify({
                        'nuevo_estado': targetColumn.toUpperCase()  // Enviar el nuevo estado
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        alert('Error al actualizar el estado.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        }
    </script>

    <!-- Modal de advertencia -->
<div class="modal fade" id="warningModal" tabindex="-1" role="dialog" aria-labelledby="warningModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title" id="warningModalLabel">Advertencia</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          ¡Solo el publicador puede publicar!
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JS and dependencies -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  
</body>
</html>
